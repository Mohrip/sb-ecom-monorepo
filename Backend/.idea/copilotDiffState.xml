<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/main/java/com/StackShop/project/order/OrderServiceImpl.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/com/StackShop/project/order/OrderServiceImpl.java" />
              <option name="originalContent" value="package com.StackShop.project.order;&#10;&#10;&#10;import com.StackShop.project.Address.Address;&#10;import com.StackShop.project.Address.AddressRepository;&#10;import com.StackShop.project.cart.Cart;&#10;import com.StackShop.project.cart.CartItem;&#10;import com.StackShop.project.cart.CartRepository;&#10;import com.StackShop.project.cart.CartService;&#10;import com.StackShop.project.exceptions.APIException;&#10;import com.StackShop.project.exceptions.ResourceNotFoundException;&#10;import com.StackShop.project.payment.Payment;&#10;import com.StackShop.project.payment.PaymentRepository;&#10;import com.StackShop.project.product.Product;&#10;import com.StackShop.project.product.ProductRepository;&#10;import jakarta.transaction.Transactional;&#10;import org.modelmapper.ModelMapper;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.stereotype.Service;&#10;&#10;import java.time.LocalDateTime;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;&#10;&#10;@Service&#10;public class OrderServiceImpl implements OrderService {&#10;&#10;    @Autowired&#10;    CartRepository cartRepository;&#10;&#10;    @Autowired&#10;    AddressRepository addressRepository;&#10;    @Autowired&#10;    private PaymentRepository paymentRepository;&#10;&#10;    @Autowired&#10;    private OrderRepository orderRepository;&#10;&#10;    @Autowired&#10;    private OrderItemRepository orderItemRepository;&#10;&#10;    @Autowired&#10;    private ProductRepository productRepository;&#10;&#10;    @Autowired&#10;    private CartService cartService;&#10;&#10;    @Autowired&#10;    private ModelMapper modelMapper;&#10;&#10;    @Override&#10;    @Transactional&#10;    public OrderDTO placeOrder(String emailId, String paymentMethod, Integer addressId, String pgName, String pgPaymentId, String pgStatus, String pgResponseMessage) {&#10;&#10;        // Use instance method, not static&#10;        Cart cart = cartRepository.findCartByEmail(emailId);&#10;        if (cart == null) {&#10;            throw new ResourceNotFoundException(&quot;Cart&quot;, &quot;User Email&quot;, emailId);&#10;        }&#10;&#10;        Address address = addressRepository.findById(addressId)&#10;                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Address&quot;, &quot;Id&quot;, addressId.toString()));&#10;&#10;        Order order = new Order();&#10;        order.setEmail(emailId);&#10;        order.setOrderDate(LocalDateTime.now());&#10;        order.setTotalAmount(cart.getTotalPrice());&#10;        order.setOrderStatus(&quot;Order Accepted !&quot;);&#10;        order.setAddress(address);&#10;&#10;        Payment payment = new Payment(paymentMethod, pgName, pgPaymentId, pgStatus, pgResponseMessage);&#10;        payment.setOrder(order);&#10;        payment = paymentRepository.save(payment);&#10;        order.setPayment(payment);&#10;&#10;        Order savedOrder = orderRepository.save(order);&#10;&#10;&#10;        List&lt;CartItem&gt; cartItems = cart.getCartItems();&#10;        if (cartItems.isEmpty()) {&#10;            throw new APIException(&quot;Cannot place order with empty cart&quot;);&#10;        }&#10;&#10;        List&lt;OrderItem&gt; orderItems = new ArrayList&lt;&gt;();&#10;        for (CartItem cartItem : cartItems) {&#10;            OrderItem orderItem = new OrderItem();&#10;            orderItem.setProduct(cartItem.getProduct());&#10;            orderItem.setQuantity(cartItem.getQuantity());&#10;            orderItem.setDiscount(cartItem.getDiscount());&#10;            orderItem.setOrderProductPrice(cartItem.getProductPrice());&#10;            orderItem.setOrder(savedOrder);&#10;            orderItems.add(orderItem);&#10;        }&#10;&#10;        orderItems = orderItemRepository.saveAll(orderItems);&#10;&#10;        // Update product quantities and clear cart&#10;        cart.getCartItems().forEach(cartItem -&gt; {&#10;            int quantity = cartItem.getQuantity();&#10;            Product product = cartItem.getProduct();&#10;            product.setQuantity(product.getQuantity() - quantity);&#10;            productRepository.save(product);&#10;            &#10;            // Delete each product from cart&#10;            cartService.deleteProductFromCart(cart.getCartId(), cartItem.getProduct().getProductId());&#10;        });&#10;&#10;        // Return order details&#10;        OrderDTO orderDTO = modelMapper.map(savedOrder, OrderDTO.class);&#10;        orderItems.forEach(item -&gt;&#10;                orderDTO.getOrderItems()&#10;                        .add(modelMapper.map(item, OrderItemDTO.class)));&#10;&#10;        return orderDTO;&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.StackShop.project.order;&#10;&#10;&#10;import com.StackShop.project.Address.Address;&#10;import com.StackShop.project.Address.AddressRepository;&#10;import com.StackShop.project.cart.Cart;&#10;import com.StackShop.project.cart.CartItem;&#10;import com.StackShop.project.cart.CartRepository;&#10;import com.StackShop.project.cart.CartService;&#10;import com.StackShop.project.exceptions.APIException;&#10;import com.StackShop.project.exceptions.ResourceNotFoundException;&#10;import com.StackShop.project.payment.Payment;&#10;import com.StackShop.project.payment.PaymentRepository;&#10;import com.StackShop.project.product.Product;&#10;import com.StackShop.project.product.ProductRepository;&#10;import jakarta.transaction.Transactional;&#10;import org.modelmapper.ModelMapper;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.stereotype.Service;&#10;&#10;import java.time.LocalDateTime;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;&#10;&#10;@Service&#10;public class OrderServiceImpl implements OrderService {&#10;&#10;    @Autowired&#10;    CartRepository cartRepository;&#10;&#10;    @Autowired&#10;    AddressRepository addressRepository;&#10;    @Autowired&#10;    private PaymentRepository paymentRepository;&#10;&#10;    @Autowired&#10;    private OrderRepository orderRepository;&#10;&#10;    @Autowired&#10;    private OrderItemRepository orderItemRepository;&#10;&#10;    @Autowired&#10;    private ProductRepository productRepository;&#10;&#10;    @Autowired&#10;    private CartService cartService;&#10;&#10;    @Autowired&#10;    private ModelMapper modelMapper;&#10;&#10;    @Override&#10;    @Transactional&#10;    public OrderDTO placeOrder(String emailId, String paymentMethod, Integer addressId, String pgName, String pgPaymentId, String pgStatus, String pgResponseMessage) {&#10;&#10;        // Use instance method, not static&#10;        Cart cart = cartRepository.findCartByEmail(emailId);&#10;        if (cart == null) {&#10;            throw new ResourceNotFoundException(&quot;Cart&quot;, &quot;User Email&quot;, emailId);&#10;        }&#10;&#10;        Address address = addressRepository.findById(addressId)&#10;                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Address&quot;, &quot;Id&quot;, addressId.toString()));&#10;&#10;        Order order = new Order();&#10;        order.setEmail(emailId);&#10;        order.setOrderDate(LocalDateTime.now());&#10;        order.setTotalAmount(cart.getTotalPrice());&#10;        order.setOrderStatus(&quot;Order Accepted !&quot;);&#10;        order.setAddress(address);&#10;&#10;        Payment payment = new Payment(paymentMethod, pgName, pgPaymentId, pgStatus, pgResponseMessage);&#10;        payment.setOrder(order);&#10;        payment = paymentRepository.save(payment);&#10;        order.setPayment(payment);&#10;&#10;        Order savedOrder = orderRepository.save(order);&#10;&#10;&#10;        List&lt;CartItem&gt; cartItems = cart.getCartItems();&#10;        if (cartItems.isEmpty()) {&#10;            throw new APIException(&quot;Cannot place order with empty cart&quot;);&#10;        }&#10;&#10;        List&lt;OrderItem&gt; orderItems = new ArrayList&lt;&gt;();&#10;        for (CartItem cartItem : cartItems) {&#10;            OrderItem orderItem = new OrderItem();&#10;            orderItem.setProduct(cartItem.getProduct());&#10;            orderItem.setQuantity(cartItem.getQuantity());&#10;            orderItem.setDiscount(cartItem.getDiscount());&#10;            orderItem.setOrderProductPrice(cartItem.getProductPrice());&#10;            orderItem.setOrder(savedOrder);&#10;            orderItems.add(orderItem);&#10;        }&#10;&#10;        orderItems = orderItemRepository.saveAll(orderItems);&#10;&#10;        // Update product quantities and clear cart&#10;        cart.getCartItems().forEach(cartItem -&gt; {&#10;            int quantity = cartItem.getQuantity();&#10;            Product product = cartItem.getProduct();&#10;            product.setQuantity(product.getQuantity() - quantity);&#10;            productRepository.save(product);&#10;            &#10;            // Delete each product from cart&#10;            cartService.deleteProductFromCart(cart.getCartId(), cartItem.getProduct().getProductId());&#10;        });&#10;&#10;        // Return order details&#10;        OrderDTO orderDTO = modelMapper.map(savedOrder, OrderDTO.class);&#10;        orderItems.forEach(item -&gt;&#10;                orderDTO.getOrderItems()&#10;                        .add(modelMapper.map(item, OrderItemDTO.class)));&#10;&#10;        return orderDTO;&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/src/main/java/com/StackShop/project/security/WebSecurityConfig.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/com/StackShop/project/security/WebSecurityConfig.java" />
              <option name="originalContent" value="package com.StackShop.project.security;&#10;&#10;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.context.annotation.Bean;&#10;import org.springframework.context.annotation.Configuration;&#10;import org.springframework.security.authentication.AuthenticationManager;&#10;import org.springframework.security.authentication.dao.DaoAuthenticationProvider;&#10;import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;&#10;import org.springframework.security.config.annotation.web.builders.HttpSecurity;&#10;import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;&#10;import org.springframework.security.config.http.SessionCreationPolicy;&#10;import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;&#10;import org.springframework.security.crypto.password.PasswordEncoder;&#10;import org.springframework.security.web.SecurityFilterChain;&#10;import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;&#10;&#10;@Configuration&#10;@EnableWebSecurity&#10;public class WebSecurityConfig {&#10;&#10;    @Autowired&#10;    UserDetailsServiceImpl userDetailsServiceImpl;&#10;&#10;    @Autowired&#10;    private AuthEntryPointJwt unauthorizedHandler;&#10;&#10;    @Bean&#10;    public AuthTokenFilter authenticationJwtTokenFilter() {&#10;        return new AuthTokenFilter();&#10;    }&#10;&#10;    @Bean&#10;    public DaoAuthenticationProvider authenticationProvider() {&#10;        DaoAuthenticationProvider authProvider = new DaoAuthenticationProvider();&#10;        authProvider.setUserDetailsService(userDetailsServiceImpl);&#10;        authProvider.setPasswordEncoder(passwordEncoder());&#10;        return authProvider;&#10;    }&#10;&#10;    @Bean&#10;    public AuthenticationManager authenticationManagerBean(AuthenticationConfiguration authConfig) throws Exception {;&#10;        return authConfig.getAuthenticationManager();&#10;    }&#10;&#10;&#10;    @Bean&#10;    public PasswordEncoder passwordEncoder() {&#10;        return new BCryptPasswordEncoder();&#10;    }&#10;&#10;    @Bean&#10;    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {&#10;        http.csrf(csrf -&gt; csrf.disable())&#10;                .exceptionHandling(exception -&gt; exception.authenticationEntryPoint(unauthorizedHandler))&#10;                .sessionManagement(session -&gt; session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))&#10;                .authorizeHttpRequests(auth -&gt; auth&#10;                                .requestMatchers(&quot;/api/auth/**&quot;).permitAll()&#10;                                .requestMatchers(&quot;/v3/api-docs/**&quot;).permitAll()&#10;                               // .requestMatchers(&quot;/api/admin/**&quot;).permitAll()&#10;                                //.requestMatchers(&quot;/api/public/**&quot;).permitAll()&#10;                                .requestMatchers(&quot;/swagger-ui/**&quot;).permitAll()&#10;                                .requestMatchers(&quot;/api/test/**&quot;).permitAll()&#10;                                .requestMatchers(&quot;/images/**&quot;).permitAll()&#10;&#10;                                .anyRequest().authenticated()&#10;                );&#10;&#10;        http.authenticationProvider(authenticationProvider());&#10;        http.addFilterBefore(authenticationJwtTokenFilter(), UsernamePasswordAuthenticationFilter.class);&#10;&#10;        return http.build();&#10;    }&#10;&#10;}&#10;" />
              <option name="updatedContent" value="package com.StackShop.project.security;&#10;&#10;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.context.annotation.Bean;&#10;import org.springframework.context.annotation.Configuration;&#10;import org.springframework.security.authentication.AuthenticationManager;&#10;import org.springframework.security.authentication.dao.DaoAuthenticationProvider;&#10;import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;&#10;import org.springframework.security.config.annotation.web.builders.HttpSecurity;&#10;import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;&#10;import org.springframework.security.config.http.SessionCreationPolicy;&#10;import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;&#10;import org.springframework.security.crypto.password.PasswordEncoder;&#10;import org.springframework.security.web.SecurityFilterChain;&#10;import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;&#10;&#10;@Configuration&#10;@EnableWebSecurity&#10;public class WebSecurityConfig {&#10;&#10;    @Autowired&#10;    UserDetailsServiceImpl userDetailsServiceImpl;&#10;&#10;    @Autowired&#10;    private AuthEntryPointJwt unauthorizedHandler;&#10;&#10;    @Bean&#10;    public AuthTokenFilter authenticationJwtTokenFilter() {&#10;        return new AuthTokenFilter();&#10;    }&#10;&#10;    @Bean&#10;    public DaoAuthenticationProvider authenticationProvider() {&#10;        DaoAuthenticationProvider authProvider = new DaoAuthenticationProvider();&#10;        authProvider.setUserDetailsService(userDetailsServiceImpl);&#10;        authProvider.setPasswordEncoder(passwordEncoder());&#10;        return authProvider;&#10;    }&#10;&#10;    @Bean&#10;    public AuthenticationManager authenticationManagerBean(AuthenticationConfiguration authConfig) throws Exception {;&#10;        return authConfig.getAuthenticationManager();&#10;    }&#10;&#10;&#10;    @Bean&#10;    public PasswordEncoder passwordEncoder() {&#10;        return new BCryptPasswordEncoder();&#10;    }&#10;&#10;    @Bean&#10;    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {&#10;        http.csrf(csrf -&gt; csrf.disable())&#10;                .exceptionHandling(exception -&gt; exception.authenticationEntryPoint(unauthorizedHandler))&#10;                .sessionManagement(session -&gt; session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))&#10;                .authorizeHttpRequests(auth -&gt; auth&#10;                                .requestMatchers(&quot;/api/auth/**&quot;).permitAll()&#10;                                .requestMatchers(&quot;/v3/api-docs/**&quot;).permitAll()&#10;                               // .requestMatchers(&quot;/api/admin/**&quot;).permitAll()&#10;                                //.requestMatchers(&quot;/api/public/**&quot;).permitAll()&#10;                                .requestMatchers(&quot;/swagger-ui/**&quot;).permitAll()&#10;                                .requestMatchers(&quot;/api/test/**&quot;).permitAll()&#10;                                .requestMatchers(&quot;/images/**&quot;).permitAll()&#10;&#10;                                .anyRequest().authenticated()&#10;                );&#10;&#10;        http.authenticationProvider(authenticationProvider());&#10;        http.addFilterBefore(authenticationJwtTokenFilter(), UsernamePasswordAuthenticationFilter.class);&#10;&#10;        return http.build();&#10;    }&#10;&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>